<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!--dragula-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.3/dragula.css" />

    <!--sql highlight-->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css"> -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/pgsql.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script> -->

    <style>
        body {
            background-color: #942A57;
            margin: 0 auto;
        }

        /* dragula-specific example page styles */
        .wrapper {
            display: table;
        }

        .dragula-container {
            display: table-cell;
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* applied to left container */
        /* .dragula-container:nth-child(odd) {
            background-color: rgba(0, 0, 0, 0.2);
        } */

        /* applied to right container */
        .dragula-container:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.2);
        }

        /* .dragula-container div { */
        .dragula-container .card {
            margin: 10px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.2);
            transition: all 0.4s ease-in-out;
        }

        .dragula-container .accordion-item {
            margin: 0px 10px 0px 10px;
            padding: 0px;
        }

        .dragula-container .ex-moved {
            background-color: #e74c3c;
        }

        #center1>.card,
        #center2>.card,
        #center3>.card,
        #center4>.card {
            color: rgb(255, 180, 180);
            display: block;
            /* inline svg & text*/
        }

        #left-handles>div,
        #center-handles>div,
        #right-handles>div {
            cursor: initial;
        }

        #left,
        #right,
        .card {
            min-width: 100px;
            /* max-width: 600px; */
        }

        #right .card {
            display: inline-block;
        }

        .handle {
            padding: 0 5px;
            margin-right: 5px;
            background-color: rgba(0, 0, 0, 0.4);
            cursor: move;
        }

        span {
            display: block;
            /* for sql format */
            overflow: hidden;
            position: relative;
            max-width: none;
            color: rgb(255, 255, 255);
        }

        .nested {
            /* padding: 16px 10px; */
            /* border: 1px dotted #bbb; */
            border-radius: 8px;
            border: 2px solid rgba(255, 180, 180, 0.5);
            /* margin-top: -1px; */
            padding: 10px 0px 10px 0px;
            /* z-index: -20; */
        }

        .accordion-collapse {
            color: white;
        }

        .accordion-item {
            /* border: unset; */
            border-color: black;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .accordion-body {
            padding: 0px;
        }

        .accordion {
            --bs-accordion-border-color: rgba(0, 0, 0, 0);
            --bs-accordion-btn-bg: unset;
            /* --bs-accordion-btn-focus-border-color: rgb(255, 0, 0); */
            /* --bs-focus-ring-color: rgba(253, 13, 110, 0.25); */
            /* --bs-accordion-btn-focus-border-color: rgb(253, 13, 110); */
            --bs-accordion-btn-focus-box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
            --bs-accordion-active-color: rgb(255, 180, 180);
            --bs-accordion-active-bg: rgba(0, 0, 0, 0.2);
            /* --bs-accordion-btn-focus-border-color: unset; */
            padding: 10px 0px 10px 0px;
            --bs-accordion-btn-active-icon: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffb4b4'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e")
                /* %23 => # */
        }

        #andor {
            padding: 32px 10px 10px 10px;
            background-color: rgba(255, 255, 255, 0.2);
            /* min-width: 400px; */
            /* max-width: 400px; */
        }

        .wrapper {
            padding-left: 0px;
        }

        #sql pre {
            margin-top: 0px;
            margin-bottom: 0px;
            /* overflow: unset; */
        }

        #sql {
            /* background-color: rgba(0, 0, 0, 0.1); */
            position: relative;
        }

        .sql {
            max-width: 300px;
        }

        .svg-icon {
            /* margin-right: 4px; */
            fill: rgb(255, 180, 180);
            /* opacity: .6; */
        }

        .language {
            position: absolute;
            top: 0;
            right: 0px;
            background-color: black;
            padding: 1px 4px 1px 4px;
        }

        #execute-btn {
            position: absolute;
            top: 28px;
            right: 8px;
        }

        #evaluate-btn, #clear-where-clause-btn {
            /* position: absolute; */
            /* top: 70px; */
            /* left: 8px; */
            margin: 2px;
        }

        .navbar {
            background-color: rgba(0, 0, 0, 0.4);
        }

        .navbar-brand {
            color: white;
            --bs-navbar-brand-hover-color: white;
        }

        .navbar-brand>img {
            width: 40px;
            overflow: hidden;
            margin: -8px -8px 0px 0px
        }

        .form-select {
            background-color: rgba(255, 255, 255, 0.5);
        }

        select,
        input {
            border-radius: 8px;
            background-color: rgba(255, 255, 255, 0.5);
        }

        .input-group {
            max-width: 300px;
        }

        .btn-sm {
            max-width: 100px;
            font-size: 8px;
        }

        span.badge {
            background-color: rgba(255, 255, 255, 0);
        }

        .card > select {
            margin: 0px 3px;
        }

        .card > input {
            margin: 0px 3px;
        }

        #where-clause {
            color: whitesmoke;
            font-size: small;
            margin:2px;
        }
    </style>
</head>

<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="box-arrow-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0v2z" />
            <path fill-rule="evenodd"
                d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708l3-3z" />
        </symbol>
        <symbol id="box-arrow-left" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0v2z" />
            <path fill-rule="evenodd"
                d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z" />
        </symbol>
        <symbol id="x" viewBox="0 0 16 16">
            <path
                d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
        </symbol>
    </svg>
    <nav class="navbar navbar-light">
        <div class="container-fluid d-flex justify-content-between">
            <a class="navbar-brand">
                <img src="https://bevacqua.github.io/dragula/resources/icon.svg" alt="Logo">
                ragula
            </a>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-light btn-sm" type="button" onclick="createDb();">createDb()</button>
                <button class="btn btn-outline-light btn-sm" type="button"
                    onclick="createObjectStore();">createObjectStore()</button>
                <button class="btn btn-outline-light btn-sm" type="button"
                    onclick="deleteObjectStore();">deleteObjectStore()</button>
                <button class="btn btn-outline-light btn-sm" type="button" onclick="deleteDb();">deleteDb()</button>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-outline-light btn-sm" type="button"
                    onclick="crudOperation('select');">crudOperation('select')</button>
                <button class="btn btn-outline-light btn-sm" type="button"
                    onclick="crudOperation('update');">crudOperation('update')</button>
                <!-- <button class="btn btn-outline-light btn-sm" type="button"
                    onclick="crudOperation('delete');">crudOperation('delete')</button> -->
            </div>
            <form class="input-group">
                <select class="form-select focus-ring focus-ring-light" name="" id="">
                    <option value="">aa</option>
                    <option value="">bb</option>
                    <option value="">cc</option>
                </select>
                <!-- <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"> -->
                <!-- <button class="btn btn-outline-light" type="submit">Save</button> -->
                <input class="btn btn-outline-light" type="button" value="resetDb()" onclick="resetDb();">
            </form>
        </div>
    </nav>
    <div class="container pt-3 row">
        <div class="col sql">
            <div id="sql">
                <pre><code id="sqls" class="language-sql">select R1, R2, R3 from tbl;</code><small class="language"><span>psql/plpgsql</span></small><button id="execute-btn" class="btn btn-light">Run</button></pre>
            </div>
            <hr>
            <p>Success</p>
            <p id="successEl"></p>
            <hr>
            <p>Error</p>
            <p id="errorEl"></p>
        </div>
        <div class='wrapper col'>
            <div id="left" class="dragula-container">
                <div class="card item">
                    <!-- <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">99+</span> -->
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                        onclick="deleteMe(this);">
                        <svg class="svg-icon" width="12" height="12">
                            <use xlink:href="#x" />
                        </svg>
                    </span>
                    L1
                </div>
                <div class="card item">
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                        onclick="deleteMe(this);">
                        <svg class="svg-icon" width="12" height="12">
                            <use xlink:href="#x" />
                        </svg>
                    </span>
                    L2
                </div>
                <div class="card item">
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                        onclick="deleteMe(this);">
                        <svg class="svg-icon" width="12" height="12">
                            <use xlink:href="#x" />
                        </svg>
                    </span>
                    L3
                </div>
            </div>
            <div class="accordion dragula-container">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true"
                            aria-controls="panelsStayOpen-collapseOne">
                            Customer Domain
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show"
                        aria-labelledby="panelsStayOpen-headingOne">
                        <div class="accordion-body" id="center1">
                            <div class="card item" data-type="date"><svg class="svg-icon handle" width="24"
                                height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>col_date</div>
                            <div class="card item" data-type="timestamp"><svg class="svg-icon handle" width="24"
                                height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>col_timestamp</div>
                            <div class="card item" data-type="text"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>col_text</div>
                            <div class="card item" data-type="varchar(5)"><svg class="svg-icon handle" width="24"
                                    height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>col_varchar_5</div>
                            <div class="card item" data-type="integer"><svg class="svg-icon handle" width="24"
                                    height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>col_integer</div>
                            <div class="card item" data-type="interval"><svg class="svg-icon handle" width="24"
                                    height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>col_interval</div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false"
                            aria-controls="panelsStayOpen-collapseTwo">
                            Service Domain
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse"
                        aria-labelledby="panelsStayOpen-headingTwo">
                        <div class="accordion-body" id="center2">
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C2_1</div>
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C2_2</div>
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C2_3</div>
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C2_4</div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingThree">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false"
                            aria-controls="panelsStayOpen-collapseThree">
                            Product Domain
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse"
                        aria-labelledby="panelsStayOpen-headingThree">
                        <div class="accordion-body" id="center3">
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C3_1</div>
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C3_2</div>
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C3_3</div>
                            <div class="card item"><svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>C3_4</div>
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header" id="panelsStayOpen-headingFour">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#panelsStayOpen-collapseFour" aria-expanded="false"
                            aria-controls="panelsStayOpen-collapseFour">
                            Clause
                        </button>
                    </h2>
                    <div id="panelsStayOpen-collapseFour" class="accordion-collapse collapse"
                        aria-labelledby="panelsStayOpen-headingFour">
                        <div class="accordion-body" id="center4">
                            <div id="andor-option" class="card item">
                                <svg class="svg-icon handle" width="24" height="24">
                                    <use xlink:href="#box-arrow-left" />
                                </svg>
                                <select onchange="setSelectedAndOr(this);">
                                    <option value="and" selected>and</option>
                                    <option value="or">or</option>
                                </select>
                                <div class="nested"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="andor" class="item">
                <select onchange="setSelectedAndOr(this);">
                    <option value="and" selected>and</option>
                    <option value="or">or</option>
                </select>
                <div id="right" class="dragula-container nested was-validated">
                    <div class="card item">
                        <!-- <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">99+</span> -->
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                            onclick="deleteMe(this);">
                            <svg class="svg-icon" width="12" height="12">
                                <use xlink:href="#x" />
                            </svg>
                        </span>
                        R1
                    </div>
                    <div class="card item">
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                            onclick="deleteMe(this);">
                            <svg class="svg-icon" width="12" height="12">
                                <use xlink:href="#x" />
                            </svg>
                        </span>
                        R2
                    </div>
                    <div class="card item">
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                            onclick="deleteMe(this);">
                            <svg class="svg-icon" width="12" height="12">
                                <use xlink:href="#x" />
                            </svg>
                        </span>
                        R3
                    </div>
                </div>
            </div>
            <div class="d-flex">
                <button id="evaluate-btn" class="btn btn-light" onclick="evaluateWhereClause()">Evaluate</button>
                <button id="clear-where-clause-btn" class="btn btn-light" onclick="$('#where-clause').html(''); showSQL();">Clear</button>
            </div>
            <div id="where-clause"></div>
        </div>
    </div>
    <script>
        function setSelectedAndOr(el) {
            // $(el).find('option[value='+el.value+']').attr('selected', 'selected')
            $(el).find('option').eq(el.selectedIndex).attr('selected', 'selected')
            $(el).find('option').eq(el.selectedIndex == 1 ? 0 : 1).removeAttr('selected')
            // console.log(el.selectedIndex);
        }
        function setSelectedValue(el) {
            // $(el).find('option[value='+el.value+']').attr('selected', 'selected')
            $(el).find('option').not(el.selectedIndex).removeAttr('selected')
            $(el).find('option').eq(el.selectedIndex).attr('selected', 'selected')
            // console.log(el.selectedIndex);
        }
        function setInput(el) {
            $(el).attr('value', el.value);
        }
    </script>
    <script>
        var drake1 = dragula([document.querySelector('#left'), document.querySelector('#center1'), document.querySelector('#center2'), document.querySelector('#center3'), document.querySelector('#center4'), document.querySelector('#right')], {
            copy: true,
            moves: function (el, source, handle, sibling) {
                //return handle.classList.contains('handle'); // elements allowed to drag
                return handle.classList.contains('handle')
            },
            accepts: function (el, target, source, sibling) {
                // return true; // elements can be dropped in any of the `containers` by default
                // return $(el).attr('id') == 'andor-option'
                return target !== document.getElementById('left') || $(el).attr('id') !== 'andor-option'
            },
            invalid: function (el, handle) {
                return false; // don't prevent any drags from initiating by default
            },
        }).on('drop', (el, target, source, sibling) => {
            el.className += ' ex-moved';
            el.children[0].remove(); // remove handle
            $(el).removeAttr('id')
            if (el.children[0] !== undefined) { // for andor-option element
                drake1.containers.push(el.children[1]);
                //drake2.containers.push(el.children[1]);
                drake3.containers.push(el.children[1]);
            }
            // for all the element dragged
            let spanEl = document.createElement('span');
            spanEl.className = 'svg-icon position-absolute top-0 start-100 translate-middle badge rounded-pill';
            spanEl.setAttribute('onclick', 'deleteMe(this);');
            let svgEl = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svgEl.setAttribute('width', '12');
            svgEl.setAttribute('height', '12');
            let useEl = document.createElementNS('http://www.w3.org/2000/svg', 'use');
            useEl.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', '#x');
            svgEl.appendChild(useEl);
            spanEl.appendChild(svgEl);
            el.prepend(spanEl);
            // if dropped on the right
            if (target == document.getElementById('right')) {
                if (el.getAttribute('data-type') !== null) {
                    el.innerHTML += '<select onchange="setSelectedValue(this);"><option selected>=</option><option>>=</option><option><=</option><option>></option><option><</option><option>!=</option><option>like</option><option>is null</option><option>is not null</option></select>'
                    if (el.getAttribute('data-type') == 'date') {
                        el.innerHTML += '<input type="date" value="1999-01-01" onchange="setInput(this)"/>'
                    } else if (el.getAttribute('data-type') == 'timestamp') {
                        el.innerHTML += '<input type="date" value="1999-01-01" onchange="setInput(this)"/><input type="time" value="23:59" onchange="setInput(this)"/>'
                    } else if (el.getAttribute('data-type') == 'text') {
                        el.innerHTML += '<input type="text" value="text" onchange="setInput(this)"/>'
                    } else if (el.getAttribute('data-type').substr(0, 7) == 'varchar') {
                        el.innerHTML += '<input type="text" value="varch" maxlength="' + el.getAttribute('data-type').split('(')[1].split(')')[0] + ' onchange="setInput(this)""/>'
                        // "maxlength="'+el.getAttribute('data-type').split('(')[1].split(')')[0]+'"/>'
                    } else if (el.getAttribute('data-type') == 'integer') {
                        el.innerHTML += '<input type="number" value="0" onchange="setInput(this)"/>'
                    } else if (el.getAttribute('data-type') == 'interval') {
                        el.innerHTML += '<input type="number" value="1" onchange="setInput(this)"/><select onchange="setSelectedValue(this);"><option selected>year</option><option>month</option><option>day</option><option>hour</option><option>minute</option><option>second</option></select>'
                    } else {
                        //
                    }
                }
            }
        });
        var drake2 = dragula([document.querySelector('#left')], {
            removeOnSpill: true,
        }).on('drag', (el) => { // after drag
            el.className = el.className.replace('ex-moved', '');
        });
        var drake3 = dragula([document.querySelector('#right')], {
            removeOnSpill: true,
            direction: 'horizontal',
        }).on('drag', (el) => { // after drag
            el.className = el.className.replace('ex-moved', '');
        });
    </script>
    <script>
        const target = document.getElementById('left');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                showSQL();
            });
        });
        const config = {
            attribute: true,
            childList: true,
            CharacterData: true,
        };
        observer.observe(target, config);
        function showSQL() {
            let columns = [];
            for (let i = 0; i < $('#left').children().length; i++) {
                //columns.push($('#left').children()[i].innerText);
                columns.push([].reduce.call($('#left').children()[i].childNodes, function (a, b) { return a + (b.nodeType === 3 ? b.textContent : ''); }, '').replaceAll(' ', '').replaceAll('\n', '')); //
            }
            $('#sql').html('<pre><code id="sqls" class="language-sql">select ' + columns.join(',\n ') + ' from tbl' + ($('#where-clause').html()==''?'':' where ' + $('#where-clause').html()) + ';</code><small class="language"><span>psql/plpgsql</span></small><button id="execute-btn" class="btn btn-light">Run</button></pre>');
            hljs.highlightAll();
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script>
        const DB_NAME = "MyFavoriteSetup";
        const DB_VERSION = 1;
        const DB_VERSION_AFTER_CREATED = 2;
        const DB_VERSION_AFTER_DELETED = 3;
        const objectStoreName = "columns";
        const errorEl = document.getElementById("errorEl");
        const successEl = document.getElementById("successEl");
        const newItems = [
            {
                id: '#12345#user_id',
                name: 'test taro',
                taskTitle: "Walk dog",
                hours: 19,
                minutes: 30,
                day: 24,
                month: "December",
                year: 2013,
                notified: "no",
            },
        ];

        function createDb() {
            const createRequest = window.indexedDB.open(DB_NAME, DB_VERSION);
            createRequest.onerror = (event) => {
                errorEl.innerHTML = event.target.error;
            };
            createRequest.onsuccess = (event) => {
                db = event.target.result;
                successEl.innerHTML = `${DB_NAME} created. (version: ${event.target.result.version})`;
                db.close();
            };
        }

        function createObjectStore() {
            const DBOpenRequest = window.indexedDB.open(DB_NAME, DB_VERSION_AFTER_CREATED);
            DBOpenRequest.onupgradeneeded = (event) => {
                const db = event.target.result;
                const objectStore = db.createObjectStore(objectStoreName, { keyPath: "id" });
                successEl.innerHTML = `${objectStoreName} created in ${DB_NAME}`;
                db.close();
            };
        }

        function crudOperation(crud) {
            if (['insert', 'select', 'update', 'delete'].includes(crud)) {
                successEl.innerHTML += `Operation: ${crud}`;
                const DBOpenRequest = window.indexedDB.open(DB_NAME);
                DBOpenRequest.onerror = (event) => {
                    errorEl.innerHTML += event.target.error;
                };
                DBOpenRequest.onsuccess = (event) => {
                    const left = $('#left');
                    db = DBOpenRequest.result;
                    const transaction = db.transaction([objectStoreName], 'readwrite');
                    transaction.oncomplete = (event) => {
                        successEl.innerHTML += `<li>Transaction completed.</li>`;
                    };
                    transaction.onerror = (event) => {
                        errorEl.innerHTML += `<li>Transaction not opened due to error: ${transaction.error}</li>`;
                    };
                    const objectStore = transaction.objectStore(objectStoreName);

                    if (crud == 'insert') {
                        //use 'update' method
                        //const objectStoreRequest = objectStore.add(xxx);
                    } else if (crud == 'select') {
                        const objectStoreRequest = objectStore.get('1111');
                        objectStoreRequest.onerror = (event) => {
                            errorEl.innerHTML += `<li>Request failed: ${event.target.error}</li>`;
                        }
                        objectStoreRequest.onsuccess = (event) => {
                            if (typeof objectStoreRequest.result === 'undefined') {
                                successEl.innerHTML += `${objectStoreRequest.result}`;
                            } else {
                                successEl.innerHTML += `<li>Request successful.</li>`;
                                left.html(objectStoreRequest.result.divs.join(''));
                            }
                        };
                    } else if (crud == 'update') { // inserted if id not exist
                        let leftChildren = [];
                        for (i = 0; i < left[0].children.length; i++) {
                            leftChildren.push(left[0].children[i].outerHTML);
                        }
                        const objectStoreRequest = objectStore.put({ id: '1111', divs: leftChildren });
                        objectStoreRequest.onerror = (event) => {
                            errorEl.innerHTML += `<li>Request failed: ${event.target.error}</li>`;
                        }
                        objectStoreRequest.onsuccess = (event) => {
                            successEl.innerHTML += `<li>Request successful.</li>`;
                        };
                    } else if (crud == 'delete') {
                        const objectStoreRequest = objectStore.delete('1111');
                        objectStoreRequest.onerror = (event) => {
                            errorEl.innerHTML += `<li>Request failed: ${event.target.error}</li>`;
                        }
                        objectStoreRequest.onsuccess = (event) => {
                            successEl.innerHTML += `<li>Request successful.</li>`;
                        };
                    } else {
                        errorEl.innerHTML = `<il>...</li>`;
                    }
                    db.close();
                };
            } else {
                errorEl.innerHTML += `Please input one of the followings: 'insert', 'select', 'update', 'delete'`;
            }
            // const DBOpenRequest = window.indexedDB.open(DB_NAME);
        }

        function deleteObjectStore() {
            const DBOpenRequest = window.indexedDB.open(DB_NAME, DB_VERSION_AFTER_DELETED);
            DBOpenRequest.onerror = (event) => {
                //console.log("error");
                errorEl.innerHTML = event.target.error;
            };
            DBOpenRequest.onupgradeneeded = (event) => {
                const db = event.target.result;
                const objectStoreDelete = db.deleteObjectStore(objectStoreName);
                successEl.innerHTML = `ObjectStore: ${objectStoreName} in ${DB_NAME} deleted`;
            };
        }
        function deleteDb() {
            const createRequest = window.indexedDB.deleteDatabase(DB_NAME);
            successEl.innerHTML = `DB: ${DB_NAME} deleted`;
        }

        function resetDb() {
            deleteObjectStore();
            deleteDb();
            createDb();
            createObjectStore();
        }
    </script>
    <script>
        function deleteMe(el) {
            //alert('me');
            el.parentElement.remove();
        }
    </script>
    <script>
        function removeEmptyNodeInContainer() {
  document.querySelectorAll('#right div.nested').forEach(x => {
    if(!x.hasChildNodes()) {
      x.parentNode.remove()
    }
  })
}
function node2Obj(n) {
  o = {};
  o['items'] = [];
  for (let i = 0; i < n.children.length; i++) {
    if (n.children[i].nodeName == 'DIV') { // n.children[i]: div.nested, div.item, or 'xxx'
      if (n.children[i].classList.contains('nested')) { // n.children[i]: div.nested
        for (let j = 0; j < n.children[i].children.length; j++) { // for node containing input, convert itself
          if (n.children[i].children[j] !== undefined) {
            for (let jj = 0; jj < n.children[i].children[j].childNodes.length; jj++) {
              if (n.children[i].children[j].childNodes[jj].nodeName === 'INPUT') { // input nodeの2つ前がtext nodeであるという設計を前提にしている
                //↓ if ignoring data-type
                //n.children[i].children[j].innerHTML = '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" onclick="deleteMe(this);"><svg class="svg-icon" width="12" height="12"><use xlink:href="#x" /></svg></span>' + n.children[i].children[j].childNodes[jj-2].nodeValue
                //↓ if caring about data-type
                if (n.children[i].children[j].getAttribute('data-type') == 'date' || n.children[i].children[j].getAttribute('data-type') == 'text' || n.children[i].children[j].getAttribute('data-type').substr(0, 7) == 'varchar') {
                  n.children[i].children[j].innerHTML = '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" onclick="deleteMe(this);"><svg class="svg-icon" width="12" height="12"><use xlink:href="#x" /></svg></span>' + n.children[i].children[j].childNodes[jj-2].nodeValue + $(n.children[i].children[j].childNodes[jj-1], 'option:selected').val() + '\'' + n.children[i].children[j].childNodes[jj].value + '\''
                } else if (n.children[i].children[j].getAttribute('data-type') == 'timestamp') {
                  n.children[i].children[j].innerHTML = '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" onclick="deleteMe(this);"><svg class="svg-icon" width="12" height="12"><use xlink:href="#x" /></svg></span>' + n.children[i].children[j].childNodes[jj-2].nodeValue + $(n.children[i].children[j].childNodes[jj-1], 'option:selected').val() + '\'' + n.children[i].children[j].childNodes[jj].value + 'T' + n.children[i].children[j].childNodes[jj+1].value + '\''
                } else if (n.children[i].children[j].getAttribute('data-type') == 'integer') {
                  n.children[i].children[j].innerHTML = '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" onclick="deleteMe(this);"><svg class="svg-icon" width="12" height="12"><use xlink:href="#x" /></svg></span>' + n.children[i].children[j].childNodes[jj-2].nodeValue + $(n.children[i].children[j].childNodes[jj-1], 'option:selected').val() + n.children[i].children[j].childNodes[jj].value
                } else if (n.children[i].children[j].getAttribute('data-type') == 'interval') {
                  n.children[i].children[j].innerHTML = '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" onclick="deleteMe(this);"><svg class="svg-icon" width="12" height="12"><use xlink:href="#x" /></svg></span>' + n.children[i].children[j].childNodes[jj-2].nodeValue + $(n.children[i].children[j].childNodes[jj-1], 'option:selected').val() + '\'' + n.children[i].children[j].childNodes[jj].value + $(n.children[i].children[j].childNodes[jj+1], 'option:selected').val() + '\''
                } else {
                  n.children[i].children[j].innerHTML = '<span class="position-absolute top-0 start-100 translate-middle badge rounded-pill" onclick="deleteMe(this);"><svg class="svg-icon" width="12" height="12"><use xlink:href="#x" /></svg></span>' + n.children[i].children[j].childNodes[jj-2].nodeValue
                }
              }
            }
          }
        }
        o['items'].push(n.children[i]);
      } else if (n.children[i].classList.contains('item')) { // n.children[i]: div.item
        if (n.children[i].children.length == 1) {
          o['items'].push(n.children[i].textContent.replaceAll(' ', '').replaceAll('\n', ''));
        //   o['items'].push(n.children[i].childNodes[n.children[i].childNodes.length-1]);
        } else {
          o['items'].push(n.children[i]);
        }
      }
    } else if (n.children[i].nodeName == 'SELECT') { // n: div.item, n.children[i]: selected !div.nested
      // o['selectTag'] = 'and';
      o['selectTag'] = $(n.children[i], 'option:selected').val()
    }
  }
  // if (o.items.length==0) {
  //   return
  // } else {
  //   return o // {'items': , 'selectedTag':'and'}
  // }
  return o // {'items': , 'selectedTag':'and'}
}
function iterate1Deeper(o) {
  for (let i = 0; i < o.items.length; i++) {
    if (o.items[i].parentNode == undefined) { // 'text'.parentNode
      // do nothing = stop iteration
    } else {
      o.items[i] = node2Obj(o.items[i]) // converted to node to obj // input: div > output: {items:[div, div]}
      // if (!o.items[i].hasChildNode) { // 
      //   // do nothing = stop iteration
      // } else {
      //   iterate1Deeper(o.items[i]) // param node
      // }
      iterate1Deeper(o.items[i]) // param node
    }
  }
}
function trimBySelect(j) {
  if (j.selectTag == undefined) { // assuming that j.items = ["text", "text", "text"] but 
  } else { // incl selectTag: json, 
    if (j.items[0].items.length == 1) {
      return j.items[0].items[0]
    } else {
      return '(' + j.items[0].items.join(' ' + j.selectTag + ' ') + ')'
    }
  }
}
function getTrimmablePosition(j, loc) {
  let l = [...loc]
  let a = {}
  if (j.selectTag == undefined) {
    // do nothing
  } else {
    let flag = false
    for (let i = 0; i < j.items[0].items.length; i++) {
      if (j.items[0].items[i].selectTag == undefined) {
        a[i]=''
      } else {
        a[i]=i
        flag = true
      }
    }
    if (flag == false) {
      //console.log(trimBySelect(j))
      selectArr.push(l)
    } else {
      for (let i = 0; i < j.items[0].items.length; i++) {
        if (j.items[0].items[i].selectTag == undefined) {
        } else {
          l.push(a[i])
          let jj = { ...j.items[0].items[a[i]] }
          getTrimmablePosition(jj, l)
          l.pop()
        }
      }
    }
  }
}
function trimmer(o, a) {
  if (a.length == 0) {
    // return
    o = trimBySelect(o)
  } else if (a.length == 1) {
    o.items[0].items[a[0]] = trimBySelect(o.items[0].items[a[0]])
  } else if (a.length == 2) {
    o.items[0].items[a[0]].items[0].items[a[1]] = trimBySelect(o.items[0].items[a[0]].items[0].items[a[1]])
  } else if (a.length == 3) {
    o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]] = trimBySelect(o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]])
  } else if (a.length == 4) {
    o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]].items[0].items[a[3]] = trimBySelect(o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]].items[0].items[a[3]])
  } else if (a.length == 5) {
    o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]].items[0].items[a[3]].items[0].items[a[4]] = trimBySelect(o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]].items[0].items[a[3]].items[0].items[a[4]])
  } else if (a.length == 6) {
    o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]].items[0].items[a[3]].items[0].items[a[4]].items[0].items[a[5]] = trimBySelect(o.items[0].items[a[0]].items[0].items[a[1]].items[0].items[a[2]].items[0].items[a[3]].items[0].items[a[4]].items[0].items[a[5]])
  } else {
    return
  }
  return o
}
function evaluateWhereClause() {
removeEmptyNodeInContainer()
root = document.getElementById('andor')
ori = root.innerHTML
json = node2Obj(root)
iterate1Deeper(json) // remove inputs
//json // json is correct
selectArr = [] // initialize

//getTrimmablePosition(json, [])
let flag = true
while(flag) {
  getTrimmablePosition(json, []) // push locationp[i0,i2] to selectArr[[],[]]
  if (JSON.stringify(selectArr) == '[[]]') { // selectArr.length == 0
    //trimmer(json, [])
    flag = false
  } else {
    for (let i = 0; i < selectArr.length; i++) {
      trimmer(json, selectArr[i])
    }
    selectArr=[]
  }
}
document.getElementById('where-clause').innerText = trimmer(json, [])
showSQL()
//successEl.innerHTML += trimmer(json, [])
}
    </script>
</body>

</html>